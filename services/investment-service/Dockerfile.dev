FROM golang:1.21-alpine 

WORKDIR /app

# Install git, netcat, and postgresql-client for connection testing
RUN apk add --no-cache git netcat-openbsd postgresql-client

# Install Air for hot reloading
RUN go install github.com/cosmtrek/air@v1.49.0

# Install Swagger CLI tool (only once)
RUN go install github.com/swaggo/swag/cmd/swag@latest

# Copy go.mod and go.sum first for better caching
COPY go.mod go.sum ./
RUN go mod download

# Copy the rest of the files
COPY . .

# Generate Swagger documentation with proper parameters
RUN cd cmd && swag init -g main.go --parseDependency --parseInternal --output ../docs

COPY wait-for-db.sh /wait-for-db.sh
RUN chmod +x /wait-for-db.sh

CMD ["/bin/sh", "-c", "/wait-for-db.sh postgres:5432 && air -c .air.toml"]